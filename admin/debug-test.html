<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Test - Rental Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { background: #f8f9fa; padding: 15px; border-radius: 3px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Rental Flow Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Test Appointment Data Processing</h2>
        <button onclick="testAppointmentFlow()">Simulate Appointment Flow</button>
        <div id="appointment-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Rental Creation</h2>
        <button onclick="testRentalCreation()">Test Rental Form Submission</button>
        <div id="rental-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Transaction Retrieval</h2>
        <input type="text" id="transaction-id" placeholder="Enter Transaction ID" style="padding: 5px; margin: 10px;">
        <button onclick="testTransactionRetrieval()">Test Dashboard Retrieval</button>
        <div id="retrieval-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Recent Transactions</h2>
        <button onclick="listRecentTransactions()">List Recent Transactions</button>
        <div id="recent-output" class="output"></div>
    </div>

    <script type="module">
        import {
            chandriaDB,
            collection,
            getDoc,
            getDocs,
            addDoc,
            query,
            where,
            doc,
            orderBy,
            limit
        } from "./assets/js/sdk/chandrias-sdk.js";

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        window.testAppointmentFlow = function() {
            const output = document.getElementById('appointment-output');
            output.innerHTML = '';
            
            log('appointment-output', 'Testing appointment data structure...');
            
            const testData = {
                customerName: "Debug Test Customer",
                customerContact: "09123456789",
                eventDate: "2025-06-01",
                cartItems: [
                    {
                        productId: "test123",
                        name: "Test Elegant Gown",
                        code: "TEG001",
                        price: 3500,
                        size: "L",
                        quantity: 1,
                        type: "product"
                    },
                    {
                        productId: "test456", 
                        name: "Test Veil",
                        code: "TV001",
                        price: 500,
                        size: "OneSize",
                        quantity: 1,
                        type: "accessory"
                    }
                ],
                totalAmount: 4000
            };
            
            log('appointment-output', 'Appointment data created: ' + JSON.stringify(testData, null, 2));
            log('appointment-output', 'Cart items count: ' + testData.cartItems.length, 'success');
            
            // Validate each cart item
            testData.cartItems.forEach((item, index) => {
                const valid = item.productId && item.name && item.price && item.size && item.quantity;
                log('appointment-output', `Cart item ${index}: ${valid ? 'VALID' : 'INVALID'}`, valid ? 'success' : 'error');
                if (!valid) {
                    log('appointment-output', `Missing fields: ${JSON.stringify(item)}`, 'error');
                }
            });
        };

        window.testRentalCreation = async function() {
            const output = document.getElementById('rental-output');
            output.innerHTML = '';
            
            log('rental-output', 'Testing rental creation with test data...');
            
            try {
                const testTransaction = {
                    fullName: "Test Customer",
                    contactNumber: "09123456789",
                    eventStartDate: "2025-06-01",
                    eventEndDate: "",
                    eventType: "Wedding",
                    rentalFee: 4000,
                    rentalType: "Fixed Rental",
                    paymentMethod: "Cash",
                    paymentType: "Full Payment", 
                    totalPayment: 4000,
                    remainingBalance: 0,
                    referenceNo: "CASH",
                    region: "NCR",
                    city: "Manila",
                    address: "Test Address",
                    notes: "Debug test transaction",
                    timestamp: new Date().toISOString(),
                    products: [
                        {
                            id: "test123",
                            code: "TEG001", 
                            name: "Test Elegant Gown",
                            sizes: { "L": 1 },
                            price: 3500
                        }
                    ],
                    accessories: [
                        {
                            id: "test456",
                            code: "TV001",
                            name: "Test Veil", 
                            price: 500,
                            quantity: 1
                        }
                    ],
                    transactionCode: "TRNS-TEST-" + Date.now()
                };
                
                log('rental-output', 'Creating test transaction...');
                log('rental-output', 'Products: ' + JSON.stringify(testTransaction.products, null, 2));
                
                const docRef = await addDoc(collection(chandriaDB, "transaction"), testTransaction);
                log('rental-output', 'Transaction created with ID: ' + docRef.id, 'success');
                
                // Immediately retrieve to verify
                const savedDoc = await getDoc(docRef);
                if (savedDoc.exists()) {
                    const savedData = savedDoc.data();
                    log('rental-output', 'Verification: Transaction saved correctly', 'success');
                    log('rental-output', 'Saved products: ' + JSON.stringify(savedData.products, null, 2), 'success');
                    
                    // Store the ID for testing retrieval
                    window.lastTestTransactionId = docRef.id;
                } else {
                    log('rental-output', 'ERROR: Could not retrieve saved transaction', 'error');
                }
                
            } catch (error) {
                log('rental-output', 'ERROR: ' + error.message, 'error');
                console.error('Test rental creation error:', error);
            }
        };

        window.testTransactionRetrieval = async function() {
            const output = document.getElementById('retrieval-output');
            const transactionId = document.getElementById('transaction-id').value || window.lastTestTransactionId;
            output.innerHTML = '';
            
            if (!transactionId) {
                log('retrieval-output', 'Please enter a transaction ID or run the rental creation test first', 'error');
                return;
            }
            
            log('retrieval-output', 'Testing retrieval for transaction: ' + transactionId);
            
            try {
                const docSnap = await getDoc(doc(chandriaDB, "transaction", transactionId));
                
                if (!docSnap.exists()) {
                    log('retrieval-output', 'Transaction not found!', 'error');
                    return;
                }
                
                const data = docSnap.data();
                log('retrieval-output', 'Transaction retrieved successfully', 'success');
                log('retrieval-output', 'Customer: ' + data.fullName);
                log('retrieval-output', 'Products array exists: ' + (data.products ? 'YES' : 'NO'));
                log('retrieval-output', 'Products array type: ' + (Array.isArray(data.products) ? 'Array' : typeof data.products));
                log('retrieval-output', 'Products count: ' + (data.products ? data.products.length : 0));
                
                if (data.products && Array.isArray(data.products) && data.products.length > 0) {
                    log('retrieval-output', 'Products details:', 'success');
                    data.products.forEach((product, index) => {
                        log('retrieval-output', `Product ${index}: ${JSON.stringify(product, null, 2)}`);
                    });
                } else {
                    log('retrieval-output', 'No products found in transaction!', 'error');
                }
                
            } catch (error) {
                log('retrieval-output', 'ERROR: ' + error.message, 'error');
                console.error('Test retrieval error:', error);
            }
        };

        window.listRecentTransactions = async function() {
            const output = document.getElementById('recent-output');
            output.innerHTML = '';
            
            log('recent-output', 'Fetching recent transactions...');
            
            try {
                const q = query(
                    collection(chandriaDB, "transaction"),
                    orderBy("timestamp", "desc"),
                    limit(5)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    log('recent-output', 'No transactions found in database', 'error');
                    return;
                }
                
                log('recent-output', `Found ${querySnapshot.size} recent transactions:`, 'success');
                
                querySnapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const productsCount = data.products ? data.products.length : 0;
                    log('recent-output', `${index + 1}. ID: ${doc.id}`);
                    log('recent-output', `   Customer: ${data.fullName}`);
                    log('recent-output', `   Date: ${data.timestamp}`);
                    log('recent-output', `   Products: ${productsCount}`);
                    log('recent-output', `   Transaction Code: ${data.transactionCode}`);
                    log('recent-output', '---');
                });
                
            } catch (error) {
                log('recent-output', 'ERROR: ' + error.message, 'error');
                console.error('List transactions error:', error);
            }
        };
    </script>
</body>
</html>
